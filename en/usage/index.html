---
"layout": "document"
"directory": "usage/"
"title": "How To Decode using Sisimai"
"description": "Reading from STDIN, Options, Callback."
"author": "azumakuniyuki"
---

<a id = 'tohash' href = '#'></a>
<header id = 'home'>
    <div class = 'main-nav'>
        <div class = 'container'>
            <div class = 'navbar-header'>
                <button type = 'button' class = 'navbar-toggle' data-toggle = 'collapse' data-target = '.navbar-collapse'>
                    <span class = 'sr-only'>Toggle navigation</span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                </button>
                <a class = 'navbar-brand' href = '/'>
                    <h1>
                        <img class = 'img-responsive' src = '/static/images/logo/sisimai-logotype-w11.png' 
                            width = '144' alt = 'Sisimai: Mail Analyzing Interface'>
                    </h1>
                </a>
            </div>
            <div class = 'collapse navbar-collapse'>
                <ul class = 'nav navbar-nav navbar-right'>
                    <li class = 'scroll'><a href = '/en'><i class = 'fa fa-home'></i></a></li> 
                    <li class = 'scroll active'><a href = '#index'><i class = 'fa fa-arrow-circle-up'></i></a></li> 
                    <li class = 'scroll'><a href = '#stdin'>STDIN</a></li>
                    <li class = 'scroll'><a href = '#memory'>Variable</a></li>
                    <li class = 'scroll'><a href = '#delivered'>Delivered</a></li>
                    <li class = 'scroll'><a href = '#vacation'>Vacation</a></li>
                    <li class = 'scroll'><a href = '#callback'>Callback</a></li>
                    <li class = 'others'><a href = '/en/docs/'>Documents</a></li>
                    <li class = 'others'><a href = '/ja/usage/'><i class = 'fa fa-language'></i></a></li>
                    <li class = 'others'><a href = 'https://github.com/sisimai' target = 'new'><i class = 'fa fa-github'></i></a></li>
                </ul>
            </div>
        </div>
    </div> <!-- /#main-nav -->
</header> <!-- /#home -->

<section id = 'index'>
    <div class = 'container'>
        <div class = 'heading'>
            <div class = 'row'>
                <div class = 'text-center col-sm-8 col-sm-offset-2'>
                    <img src = '/static/images/logo/sisimai-x01.png' width = '20%'>
                    <h2>How To Decode Using Sisimai</h2>
                </div>
            </div>
        </div>
        <div class = 'text-center index-table'>
            <div class = 'row'>
                <div class = 'col-sm-4'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-keyboard'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Basic Usage</h3>
                        <p class = 'description'>
                            This section introduces the simplest and most basic way to use {{ site.html.ss }}.
                            Simply prepare a bounce email in an environment where {{ site.html.ss }}
                            can be used, and you can immediately obtain the decoded results, such as
                            email decoding, structured data, and JSON string acquisition.
                        </p>
                    </div>
                    <a href = '/en/start/#usage' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-4'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-desktop'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>From STDIN</h3>
                        <p class = 'description'>
                            This is an example of how to read bounce email data from standard input
                            (STDIN) and decode it with {{ site.html.ss }}. This is a convenient
                            input method when reading data using pipelines in one-liners of Perl or
                            Ruby.
                        </p>
                    </div>
                    <a href = '#stdin' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-4'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-dollar-sign'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>From Variable</h3>
                        <p class = 'description'>
                            This is an example of how to read bounce email data from a variable and
                            it with {{ site.html.ss }}. This is a convenient method when reading and
                            decoding bounce emails from databases or job queue systems.
                        </p>
                    </div>
                    <a href = '#memory' class = 'btn btn-continue'>Read</a>
                </div>
            </div>

            <div class = 'row'>
                <div class = 'col-sm-4'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-truck'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Include "Delivered"</h3>
                        <p class = 'description'>
                            By default, {{ site.html.ss }} only outputs the decoded results of emails
                            that could not be delivered. However, this article introduces how to use
                            the method of the {{ site.html.ss }} class to include emails that were
                            delivered successfully (delivery notifications) in the decoded results.
                        </p>
                    </div>
                    <a href = '#delivered' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-4'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-plane-departure'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Include "Vacation"</h3>
                        <p class = 'description'>
                            By default, {{ site.html.ss }} only outputs the decode results of emails
                            that could not be delivered. However, this article introduces how to use
                            the method of the {{ site.html.ss }} class to include emails that are
                            returned with an out-of-office (vacation) response in the decoded results.
                        </p>
                    </div>
                    <a href = '#vacation' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-4'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-reply-all'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Callback</h3>
                        <p class = 'description'>
                            The callback feature allows you to perform custom processing on the data
                            before it is decoded by {{ site.html.ss }}. This includes retrieving specific
                            headers, partially rewriting the data, and including the results in the
                            decoded data.
                        </p>
                    </div>
                    <a href = '#callback' class = 'btn btn-continue'>Read</a>
                </div>
            </div>
        </div>
    </div>
</section> <!-- /#index -->

<section id = 'stdin' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-desktop'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>Read From STDIN</h2>
                <hr>
                <p class = 'description cation'>
                    The <span class = 'value'>make()</span> method of the <span class = 'value'>Sisimai</span>
                    class has been deprecated in {{ site.html.ss }} 5.0.0. Please use the newly implemented
                    <span class = 'value'>rise()</span>
                    method instead.
                </p>
                <p class = 'description'>
                    The <span class = 'value'>rise()</span> and <span class = 'value'>dump()</span> methods of
                    <span class = 'value'>Sisimai</span> class can read bounce email data from standard input (STDIN)
                    in addition to specifying a filename as an argument. This feature was implemented in early versions of
                    {{ site.html.ss }}, but there was a bug that sometimes prevented it from working
                    properly. This bug has been fixed in {{ site.html.ss }} 4.18.1
                    <a href = 'https://github.com/sisimai/p5-sisimai/issues/194' target = 'new'>Perl version</a> and the
                    <a href = 'https://github.com/sisimai/rb-sisimai/issues/61' target = 'new'> Ruby version</a>.
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDIN File Handle</h4>
                <p class = 'description'>
                    The <span class = 'value'>dump()</span> and <span class = 'value'>rise()</span> methods of the
                    <span class = 'value'>Sisimai</span> class read bounce email data from standard input and return
                    the decoded results when the first argument is <kbd>STDIN</kbd> as the file handle.
                </p>

                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print Sisimai->dump(STDIN)' | jq</kbd>
[
  {
    "listid": "",
    "smtpagent": "Sendmail",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print $_->recipient->address for @{ Sisimai->rise(STDIN) }'</kbd>
kijitora@example.jp
sironeko@example.org
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDIN Object</h4>
                <p class = 'description'>
                    The Ruby version of {{ site.html.ss }} also works similarly. When the first
                    argument of the <span class = 'value'>dump()</span> and <span class = 'value'>rise()</span> methods of the
                    <span class = 'value'>Sisimai</span> class is the <kbd>STDIN</kbd> object, it reads bounce email data from
                    standard input and returns the decoded results.
                </p>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -Ilib -rsisimai -e 'puts Sisimai.dump(STDIN)' | jq</kbd>
[
  {
    "catch": "",
    "token": "d295b517a3ad6f8748031e1068e07ebd089c0277",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -rsisimai -e 'p Sisimai.rise(STDIN)'</kbd>
[#&lt;Sisimai::Fact:0x007fa1b0993050 @addresser=#&lt;Sisimai::Address:0x007fa1b0990e40 @user="kijitora", ...
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

    </div>
</section> <!-- /#stdin -->

<section id = 'memory' class = ''>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-dollar-sign'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>Read From Variable</h2>
                <p class = 'description cation'>
                    The <span class = 'value'>make()</span> method of the <span class = 'value'>Sisimai</span>
                    class has been deprecated in {{ site.html.ss }} 5.0.0. Please use the newly implemented
                    <span class = 'value'>rise()</span> method instead.
                </p>
                <p class = 'description'>
                    The <span class = 'value'>rise()</span> and <span class = 'value'>dump()</span> methods of the
                    <span class = 'value'>Sisimai</span> class allow you to read bounce email data from sources other than files and
                    standard input by specifying a variable (a scalar reference in Perl and a <span class = 'value'>String</span>
                    object in Ruby) as the first argument. This feature (<span class = 'value'>Sisimai::Mail::Memory</span>),
                    which is useful for reading bounce emails from databases and job queue systems,
                    was implemented in {{ site.html.ss }} 4.23.0.
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Scalar Reference</h4>
                <p class = 'description'>
                    When a scalar reference is specified as the first argument to <span class = 'value'>rise()</span>
                    method and <span class = 'value'>dump()</span> method, <span class = 'value'>Sisimai::Mail::Memory</span>
                    is called internally, and the decoded results are obtained in the same way as when reading
                    from a mail file or standard input.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = 'From MAILER-DAEMON Thu Dec 22 17:54:04 2015...';   # Entire bounce message
my $v = Sisimai->rise(\$f);
for my $e ( @$v ) {
    print $e->action;           # "delayed"
    print $e->deliverystatus;   # "4.7.0"
    print $e->reason;           # "expired"
    print $e->diagnosticcode;   # "Envelope expired"
    print $e->hardbounce;       # 0
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>String object</h4>
                <p class = 'description'>
                    In the Ruby version of {{ site.html.ss }}, when a <span class = 'value'>String</span>
                    object is specified as the first argument to <span class = 'value'>rise()</span>
                    method and <span class = 'value'>dump()</span> method, <span class = 'value'>Sisimai::Mail::Memory</span>
                    is called internally, and the decoded results are obtained in the same way as when reading from a mail file or standard
                    input.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = 'From MAILER-DAEMON Thu Dec 22 17:54:04 2015...'    # Entire bounce message
v = Sisimai.rise(f)
v.each do |e|
  puts e.action         # "delayed"
  puts e.deliverystatus # "4.7.0"
  puts e.reason         # "expired"
  puts e.diagnosticcode # "Envelope expired"
  puts e.hardbounce     # false
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#memory -->

<section id = 'delivered' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-truck'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>Include Delivery Success</h2>
                <p class = 'description cation'>
                    The <span class = 'value'>make()</span> method of the <span class = 'value'>Sisimai</span>
                    class has been deprecated in {{ site.html.ss }} 5.0.0. Please use the newly implemented
                    <span class = 'value'>rise()</span>
                    method instead.
                </p>
                <p class = 'description'>
                    The <span class = 'value'>rise()</span> and <span class = 'value'>dump()</span> methods of the
                    <span class = 'value'>Sisimai</span> class can include emails that notify you of successful delivery
                    by specifying <kbd>delivered</kbd> as the second argument.
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Succeeded Delivery as a Sample</h3>
                <p class = 'description'>
                    <img class = 'lhs' src = '/static/images/icon/message-3.png'>
                    Emails that were successfully delivered are available as samples in the
                    <a href = 'https://github.com/sisimai/set-of-emails' target = 'new'>github.com/sisimai/set-of-emails</a>
                    repository.  Specifically, the 
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/rfc3464-28.eml' target = 'new'>
                        rfc3464-28.eml
                    </a>
                    can be used as an example.
                    This section provides sample code for decoding this email.
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered =&gt; 1</h4>
                <p class = 'description'>
                    The second argument of <span class = 'value'>rise()</span> and <span class = 'value'>dump()</span>
                    takes a <kbd>delivered</kbd> key-value pair. When set to <kbd>1</kbd>, the decoded results will include emails
                    that were successfully delivered (delivery notifications). If <kbd>delivered</kbd>
                    is set to a false value (<kbd>0</kbd>, <kbd>undef</kbd>, or an empty string),
                    the decoded results will not be generated.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/rfc3464-28.eml';
my $v = Sisimai->rise($f, <strong>'delivered' => 1</strong>);
for my $e ( @$v ) {
    print $e->action;           # "delivered"
    print $e->deliverystatus;   # "2.1.5"
    print $e->reason;           # "delivered"
    print $e->diagnosticcode;   # "250 2.1.5 Ok"
    print $e->hardbounce;       # 0
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered: true</h4>
                <p class = 'description'>
                    Similarly to the Perl version, in the Ruby version of {{ site.html.ss }},
                    specifying <kbd>delivered: true</kbd> as the second argument of <span class = 'value'>rise()</span>
                    and <span class = 'value'>dump()</span> will include emails that were successfully delivered
                    (delivery notifications) in the decoded results. If a false value (<kbd>nil</kbd>
                    or <kbd>false</kbd>) is specified for delivered, the decoded results will not
                    be generated.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/rfc3464-28.eml'
v = Sisimai.rise(f, <strong>delivered: true</strong>)
v.each do |e|
  puts e.action         # "delivered"
  puts e.deliverystatus # "2.1.5"
  puts e.reason         # "delivered"
  puts e.diagnosticcode # "250 2.1.5 Ok"
  puts e.hardbounce     # false
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#delivered -->

<section id = 'vacation' class = 'not-parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-plane-departure'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>Include Vacation</h2>
                <p class = 'description cation'>
                    The <span class = 'value'>make()</span> method of the <span class = 'value'>Sisimai</span>
                    class has been deprecated in {{ site.html.ss }} 5.0.0. Please use the newly implemented
                    <span class = 'value'>rise()</span> method instead.
                </p>
                <p class = 'description cation'>
                    Starting with {{ site.html.ss }} 5.0.0, bounce emails with a bounce reason of
                    <span class = 'value'>"vacation"</span> will no longer be decoded by default.
                    If you need this functionality, you must specify the <kbd>vacation</kbd> parameter
                    to the <span class = 'value'>rise()</span> method.
                </p>
                <p class = 'description'>
                    The <span class = 'value'>rise()</span> and <span class = 'value'>dump()</span>
                    methods of the <span class = 'value'>Sisimai</span>
                    class can include vacation response emails in the decoded results by specifying
                    <kbd>vacation</kbd> as the second argument.
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Vacation email as a sample</h3>
                <p class = 'description'>
                    <img class = 'lhs' src = '/static/images/icon/message-3.png'>
                    A sample of a vacation response email is available in the
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/rfc3834-01.eml' target = 'new'>
                        rfc3834-01.eml
                    </a>
                    in the
                    <a href = 'https://github.com/sisimai/set-of-emails' target = 'new'>github.com/sisimai/set-of-emails</a>
                    repository. Here is a sample code that decodes this email.
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>vacation =&gt; 1</h4>
                <p class = 'description'>
                    Specifying <kbd>vacation => 1</kbd> as the second argument of <span class = 'value'>rise()</span>
                    and <span class = 'value'>dump()</span> will include vacation response emails in the decoded results.
                    If a value that evaluates to false for <kbd>vacation</kbd> is specified
                    (<kbd>0</kbd>, <kbd>undef</kbd>, <kbd>''</kbd>), no decoded results will be generated.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/rfc3834-01.eml';
my $v = Sisimai->rise($f, <strong>'vacation' => 1</strong>);
for my $e ( @$v ) {
    print $e->action;           # ""
    print $e->deliverystatus;   # ""
    print $e->reason;           # "vacation"
    print $e->diagnosticcode;   # "I am currently away returning to the office on May 5th."
    print $e->hardbounce;       # 0
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>vacation: true</h4>
                <p class = 'description'>
                    Similar to the Perl version, in the Ruby version of {{ site.html.ss }},
                    specifying <kbd>vacation: true</kbd> as the second argument of <span class = 'value'>rise()</span>
                    and <span class = 'value'>dump()</span> will include vacation notification emails in the decoded
                    results. If a value that evaluates to false for <kbd>vacation</kbd> is specified
                    (<kbd>nil</kbd>, <kbd>false</kbd>), no decoded results will be generated.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/rfc3834-01.eml'
v = Sisimai.rise(f, <strong>vacation: true</strong>)
v.each do |e|
  puts e.action         # ""
  puts e.deliverystatus # ""
  puts e.reason         # "vacation"
  puts e.diagnosticcode # "I am currently away returning to the office on May 5th."
  puts e.hardbounce     # false
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#vacation -->

<section id = 'callback' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-reply-all'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2>Callback Feature</h2>
                <p class = 'description cation'>
                    The <span class = 'value'>make()</span> method of the <span class = 'value'>Sisimai</span>
                    class has been deprecated in {{ site.html.ss }} 5.0.0. Please use the newly implemented
                    <span class = 'value'>rise()</span> method instead.
                </p>
                <p class = 'description cation'>
                    The callback feature specification (number and type of arguments) has changed in
                    {{ site.html.ss }} 5.0.0. Due to the incompatible change, please check the
                    <a href = 'https://github.com/sisimai/p5-sisimai/blob/4-stable/README-JA.md#callback-feature'>GitHub/Callback Feature</a>
                    of the <span class = 'value'>4-stable</span> branch for the callback feature in Version 4.
                </p>
                <p class = 'description'>
                    The callback feature implemented in {{ site.html.ss }} 4.19.0 allows you to get
                    the results of your own bounce email processing through the <span class = 'value'>catch()</span>
                    method of <span class = 'value'>Sisimai::Fact</span> class or <span class = 'value'>Sisimai::Message</span> class.
                    This feautre is useful for extracting the entire original message that {{ site.html.ss }}
                    does not include in the decoded results, or specific header values of the original
                    message (such as the delivery ID).
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>c___</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Arguments passed to c___</h3>
                <p class = 'description'>
                    The arguments that can be passed to the <span class = 'value'>c___</span> (<span class = 'value'>c</span>
                    and three underscores, looks like a fishing hook) in the <span class = 'value'>rise()</span> method of the
                    <span class = 'value'>Sisimai</span> class are one array reference for Perl hook methods (subroutines)
                    and one <span class = 'value'>Array</span> object for Ruby hook methods. The structure of the
                    arguments is as follows:
                </p>
                <div class = 'table-responsive'>
                    <table class = 'table table-hover table-bordered'>
                        <thead>
                            <tr>
                                <th>The indices of the array passed to <span class = 'value'>c___</span></th>
                                <th>Target of processing</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class = 'ltext'>[0] (<kbd>$code0</kbd>in the following code example)</td>
                                <td>
                                    Email headers <span class = 'value'>headers</span> and message
                                    text <span class = 'value'>message</span></td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>[1] (<kbd>$code1</kbd>in the following code example)</td>
                                <td>The original email file</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <pre class = 'prettyprint'>
my $code0 = sub {
    my $args = shift;
    my $head = $args->{'headers'}; # Email headers
    my $body = $args->{'message'}; # Message body
};
my $code1 = sub {
    my $args = shift;
    my $kind = $args->{'kind'}; # (String)  Sisimai::Mail->kind
    my $mail = $args->{'mail'}; # (*String) Entire email message
    my $path = $args->{'path'}; # (String)  Sisimai::Mail->path
    my $fact = $args->{'fact'}; # (*Array)  List of Sisimai::Fact
};
my $list = Sisimai->rise('/path/to/mbox', 'c___' => [$code0, $code1]);
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>c___[0]</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Arguments inside of c___[0]</h3>
                <p class = 'description'>
                    The string obtained from the <span class = 'value'>message</span> is the body
                    of the bounce email. It does not include the headers of the bounce email itself,
                    so please refer to the hashed <span class = 'value'>headers</span>.
                </p>

                <div class = 'table-responsive'>
                    <table class = 'table table-hover table-bordered'>
                        <thead>
                            <tr>
                                <th>Key Name</th>
                                <th>Data Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class = 'ltext'>headers</td>
                                <td>Hash</td>
                                <td>Header part of a bounce mail (as a Hash Data)</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>message</td>
                                <td>String</td>
                                <td>
                                    Body part of a bounce mail(including no headers of the bounce mail)
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>c___[1]</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Arguments inside of c___[1]</h3>
                <p class = 'description'>
                    The string obtained from the <span class = 'value'>mail</span> is the entire
                    bounce email, including the headers of the bounce email itself.
                </p>
                <div class = 'table-responsive'>
                    <table class = 'table table-hover table-bordered'>
                        <thead>
                            <tr>
                                <th>Key Name</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class = 'ltext'>kind</td>
                                <td>String</td>
                                <td>The kind of the original email file</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>mail</td>
                                <td>*String</td>
                                <td>Entire message of the bounce mail including all headers</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>path</td>
                                <td>String</td>
                                <td>The path to the original email file</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>fact</td>
                                <td>Array</td>
                                <td>The List of <span class = 'value'>Sisimai::Fact</span>objects</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Email: rhost-google-03.eml</h3>
                <p class = 'description'>
                    The following code snippet demonstrates how to operate the original email by
                    obtaining the contents listed below from 
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/rhost-google-03.eml' target = 'new'>
                        rhost-google-03.eml
                    </a>
                    via a callback.
                </p>
                <ul>
                    <li>Retrieve the value of <span class = 'value'>Return-Path</span> in the bounce email header.</li>
                    <li>Retrieve the value of <span class = 'value'>Authentication-Results</span> in the bounce email header.</li>
                    <li>Retrieve the value of <span class = 'value'>X-Postfix-Queue-ID</span> in the body.</li>
                    <li>Add a custom header to the original email and save it to a different path.</li>
                </ul>

                <pre class = 'prettyprint'><strong>Return-Path: <></strong>
Received: from mail4.example.com (mx4.example.com [192.0.2.24])
	by secure.example.jp (Postfix) with ESMTPS id 4SnNbh0r3mz24sXs
	for <postmaster@example.jp>; Thu,  9 Apr 2022 23:34:45 +0900 (JST)
Received: by mail4.example.com (Postfix)
	id t8WLKlmm99zqL71C; Thu,  9 Apr 2022 23:34:45 +0900 (JST)
<strong>Authentication-Results: secure.example.jp; spf=fail smtp.helo=mail4.example.com</strong>
Date: Thu,  9 Apr 2022 23:34:45 +0900 (JST)
From: MAILER-DAEMON@mail4.example.com (Mail Delivery System)
Subject: Undelivered Mail Returned to Sender
To: nginx@mail4.example.com
...
<kijitora@google.example.com> (expanded from <neko@example.co.jp>): host
    gmail-smtp-in.l.google.com[64.233.188.26] said: 550-5.7.26 The MAIL FROM
    domain [mail4.example.com] has an SPF record with a 550-5.7.26 hard fail
    policy (-all) but it fails to pass SPF checks with the ip: 550-5.7.26
    [192.0.2.24]. To best protect our users from spam and phishing,
    550-5.7.26 the message has been blocked. For instructions on setting up
    550-5.7.26 authentication, go to 550 5.7.26
    https://support.google.com/mail/answer/81126#authentication
    2-222222630d46222222b002b2d2neko2cat2222222cat.22 - gsmtp (in reply to end
    of DATA command)

--Lms5yfCw0Vz5CRp3.1647426971/mail4.example.com
Content-Description: Delivery report
Content-Type: message/delivery-status

Reporting-MTA: dns; mail4.example.com
<strong>X-Postfix-Queue-ID: Lms5yfCw0Vz5CRp3</strong>
X-Postfix-Sender: rfc822; nginx@mail4.example.com
Arrival-Date: Thu,  9 Apr 2022 23:34:45 +0900 (JST)

Final-Recipient: rfc822; kijitora@google.example.com
Original-Recipient: rfc822;neko@example.co.jp
Action: failed
Status: 5.7.26
Remote-MTA: dns; gmail-smtp-in.l.google.com
Diagnostic-Code: smtp; 550-5.7.26 The MAIL FROM domain [mail4.example.com] has
...
                </pre>

            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai-&gt;rise($f, 'c___' => [$c0, $c1])</h4>
                <p class = 'description'>
                    You can pass two code references as the second argument <span class = 'value'>c___</span>
                    to the <span class = 'value'>rise()</span> and <span class = 'value'>dump()</span> methods
                    of the <span class = 'value'>Sisimai</span> class.
                    These code references should contain the code for the subroutine that you want
                    to execute.
                </p>
                <pre class = 'prettyprint'><strong>#! /usr/bin/env perl</strong>
use Sisimai;
my $fn = 'set-of-emails/maildir/bsd/rhost-google-03.eml';
my $c0 = sub {
    my $args = shift;
    my $data = { 'queue-id' => '', 'authentication-results' => '', 'return-path' => '' };

    $data->{'return-path'} = $args->{'headers'}->{'return-path'} || '';
    $data->{'authentication-results'} = $args->{'headers'}->{'authentication-results'} || '';
    if( $args->{'message'} =~ m/^X-Postfix-Queue-ID:\s*(.+)$/m ) {
        $data->{'queue-id'} = $1;
    }
    return $data;
};
my $c1 = sub {
    my $args = shift;
    my $kind = $args->{'kind'}; # (String)  Sisimai::Mail->kind
    my $mail = $args->{'mail'}; # (*String) Entire email message
    my $path = $args->{'path'}; # (String)  Sisimai::Mail->path
    my $fact = $args->{'fact'}; # (*Array)  List of Sisimai::Fact

    for my $e ( @$fact ) {
        # Store custom information in the "catch" accessor.
        $e->{'catch'} ||= {};
        $e->{'catch'}->{'size'} = length $$mail;
        $e->{'catch'}->{'kind'} = ucfirst $kind;

        # Save the original email with an additional "X-Sisimai-Parsed:" header to a different PATH.
        my $a = sprintf("X-Sisimai-Parsed: %d\n", scalar @$fact);
        my $f = IO::File->new(sprintf("/tmp/sisimai-%s.eml", $e->token), 'w');
        my $v = $$mail; $v =~ s/^(From:.+)$/$a$1/m;
        print $f $v; $f->close;
    }

    # Remove the email file in Maildir/ after decoding
    unlink $path if $kind eq 'maildir';
};

my $js = Sisimai->dump($fn, 'c___' => [$c0, $c1]);
my $rv = Sisimai->rise($fn, 'c___' => [$c0, $c1]);
printf("Authentication-Results: %s\n", $rv->[0]->{'catch'}->{'authentication-results'});
printf("X-Postfix-Queue-ID: %s\n", $rv->[0]->{'catch'}->{'queue-id'});
printf("Return-Path: %s\n", $rv->[0]->{'catch'}->{'return-path'});
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai.rise(f, c___: [c0, c1])</h4>
                <p class = 'description'>
                    You can pass a <span class = 'value'>Proc</span> object containing the code for
                    the function that you want to execute to the <span class = 'value'>rise()</span>
                    and <span class = 'value'>dump()</span> methods of the <span class = 'value'>Sisimai</span>
                    class as the second argument <span class = 'value'>c___</span>.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
fn = 'set-of-emails/maildir/bsd/rhost-google-03.eml'
c0 = lambda do |args|
  data = { 'queue-id' => '', 'authentication-results' => '', 'return-path' => '' }
  data['return-path'] = args['headers']['return-path'] || ''
  data['authentication-results'] = args['headers']['authentication-results'] || ''
  if cv = args['message'].match(/^X-Postfix-Queue-ID:\s*(.+)$/)
    data['queue-id'] = cv[1]
  end
  return data
end

c1 = lambda do |args|
  kind = args['kind'] # (String)  Sisimai::Mail.kind
  mail = args['mail'] # (*String) Entire email message
  path = args['path'] # (String)  Sisimai::Mail.path
  fact = args['fact'] # (*Array)  List of Sisimai::Fact

  fact.each do |e|
    # Store custom information in the "catch" accessor.
    e.catch ||= {}
    e.catch['size'] = mail.size
    e.catch['kind'] = kind

    # Save the original email with an additional "X-Sisimai-Parsed:" header to a different PATH.
    a = sprintf("X-Sisimai-Parsed: %d", fact.size)
    b = mail.sub(/^(To:.+$)/,'\1'+ "\n" + a)
    File.open(sprintf("/tmp/sisimai-%s.eml", e.token), "w") do |f|
      f.puts(b)
    end

    # Remove the email file in Maildir/ after decoding
    File.delete(path) if kind == 'maildir'
  end
end

js = Sisimai.dump(fn, c___: [c0, c1]) # JSON文字列を得る
rv = Sisimai.rise(fn, c___: [c0, c1])
printf("Authentication-Results: %s\n", rv[0].catch['authentication-results'])
printf("X-Postfix-Queue-ID: %s\n", rv[0].catch['queue-id'])
printf("Return-Path: %s\n", rv[0].catch['return-path'])
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>JSON string by dump()</h3>
                <p class = 'description'>
                    The JSON string obtained by passing a hook method to the <span class = 'value'>dump()</span>
                    method of the <span class = 'value'>Sisimai</span> class will have the following contents:
                </p>
                <pre class = 'prettyprint'>[
  {
    "addresser": "kijitora@google.example.com",
    "messageid": "vDcsF1hr4zzywp69@mail4.example.com",
    "recipient": "kijitora@google.example.com",
    "diagnosticcode": "host gmail-smtp-in.l.google.com[64.233.188.26] said: The MAIL FROM domain [mail4.example.com] has an SPF record with a hard fail policy (-all) but it fails to pass SPF checks with the ip: [192.0.2.24]. To best protect our users from spam and phishing, the message has been blocked. For instructions on setting up authentication, go to https://support.google.com/mail/answer/81126#authentication 2-222222630d46222222b002b2d2neko2cat2222222cat.22 - gsmtp (in reply to end of DATA command)",
    "smtpagent": "Postfix",
    "destination": "google.example.com",
    "alias": "neko@example.co.jp",
    "reason": "authfailure",
    "lhost": "gmail-smtp-in.l.google.com",
    "senderdomain": "google.example.com",
    "token": "fe75b94dd0489b106fa041c460064dd6afa8196b",
    "subject": "Nyaan",
    "deliverystatus": "5.7.26",
    "timezoneoffset": "+0900",
    "listid": "",
    "origin": "set-of-emails/maildir/bsd/rhost-google-03.eml",
    "action": "failed",
    "timestamp": 1649514885,
    "hardbounce": 0,
    "rhost": "gmail-smtp-in.l.google.com",
    "catch": {
      "size": 4436,
      "kind": "Mailbox",
      "authentication-results": "secure.example.jp; spf=fail smtp.helo=mail4.example.com",
      "return-path": "<>",
      "queue-id": "Lms5yfCw0Vz5CRp3"
    },
    "diagnostictype": "SMTP",
    "replycode": 550,
    "feedbacktype": "",
    "smtpcommand": "DATA"
  }
]
                </pre>



            </div>
        </div>

    </div>
</section> <!-- #callback -->

