---
"layout": "document"
"directory": "usage/"
"title": "How To Parse using Sisimai"
"description": "Reading from STDIN, Options, Callback."
"author": "azumakuniyuki"
---

<a id = 'tohash' href = '#'></a>
<header id = 'home'>
    <div class = 'main-nav'>
        <div class = 'container'>
            <div class = 'navbar-header'>
                <button type = 'button' class = 'navbar-toggle' data-toggle = 'collapse' data-target = '.navbar-collapse'>
                    <span class = 'sr-only'>Toggle navigation</span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                </button>
                <a class = 'navbar-brand' href = 'https://libsisimai.org/'>
                    <h1>
                        <img class = 'img-responsive' src = '/static/images/logo/sisimai-logotype-w11.png' 
                            width = '144' alt = 'Sisimai: Mail Analyzing Interface'>
                    </h1>
                </a>
            </div>
            <div class = 'collapse navbar-collapse'>
                <ul class = 'nav navbar-nav navbar-right'>
                    <li class = 'scroll'><a href = 'https://libsisimai.org/en/'><i class = 'fa fa-home'></i></a></li> 
                    <li class = 'scroll active'><a href = '#index'><i class = 'fa fa-arrow-circle-up'></i></a></li> 
                    <li class = 'scroll'><a href = '#stdin'>STDIN</a></li>
                    <li class = 'scroll'><a href = '#delivered'>Delivered</a></li>
                    <li class = 'scroll'><a href = '#othersrc'>Except Mails</a></li>
                    <li class = 'scroll'><a href = '#callback'>Callback</a></li>
                    <li class = 'others'><a href = '/en/docs/'>Documents</a></li>
                    <li class = 'others'><a href = '/ja/usage/'><i class = 'fa fa-language'></i></a></li>
                </ul>
            </div>
        </div>
    </div> <!-- /#main-nav -->
</header> <!-- /#home -->

<section id = 'index'>
    <div class = 'container'>
        <div class = 'heading'>
            <div class = 'row'>
                <div class = 'text-center col-sm-8 col-sm-offset-2'>
                    <img src = '/static/images/logo/sisimai-x01.png' width = '20%'>
                    <h2>How To Parse Using Sisimai</h2>
                </div>
            </div>
        </div>
        <div class = 'text-center index-table'>
            <div class = 'row'>
                <div class = 'col-sm-1'></div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-keyboard-o'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Basic Usage</h3>
                        <p class = 'description'>
                            How to parse bounce mails, to get structured data,
                            and to make parsed data as JSON.
                        </p>
                    </div>
                    <a href = '/en/start/#usage' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-desktop'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>From STDIN</h3>
                        <p class = 'description'>
                            Sample codes in Perl and Ruby for reading bounce mail
                            data from Standard-In.
                        </p>
                    </div>
                    <a href = '#stdin' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-truck'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Delivered</h3>
                        <p class = 'description'>
                            How to include a delivery success (delivery notification)
                            in the parsed results.
                        </p>
                    </div>
                    <a href = '#delivered' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-files-o'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Except Mails</h3>
                        <p class = 'description'>
                        {{ site.html.ss }} can also parse a bounce object (JSON)
                        got from Cloud Email Services.
                        </p>
                    </div>
                    <a href = '#othersrc' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-reply-all'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>Callback</h3>
                        <p class = 'description'>
                            Callback feature allows you to read each bounce message
                            before being parsed.
                        </p>
                    </div>
                    <a href = '#callback' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-1'></div>
            </div>
        </div>
    </div>
</section> <!-- /#index -->

<section id = 'stdin' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-desktop'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>Read From STDIN</h2>
                <hr>
                <p class = 'description'>
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods of {{ site.html.ss }}
                    accept <kbd>STDIN</kbd> as the first argument for reading bounce mail data
                    from Standard-In.
                    This feature had been implemented at earlier version of {{ site.html.ss }}, However, 
                    sometimes, it did not work properly caused by some bugs.
                    The bugs have been fixed in the
                    <a href = 'https://github.com/sisimai/p5-Sisimai/issues/194' target = 'new'>
                    Perl
                    </a> version and the
                    <a href = 'https://github.com/sisimai/rb-Sisimai/issues/61' target = 'new'>
                    Ruby
                    </a> version at Sisimai 4.18.1.
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDIN File Handle</h4>
                <p class = 'description'>
                    <kbd>dump()</kbd> and <kbd>make()</kbd> methods of Sisimai class
                    read bounce mail data from Standard-In when a file handle <kbd>STDIN</kbd>
                    is specified as the first argument.
                </p>

                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print Sisimai->dump(STDIN)' | jq</kbd>
[
  {
    "listid": "",
    "smtpagent": "Sendmail",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print $_->recipient->address for @{ Sisimai->make(STDIN) }'</kbd>
kijitora@example.jp
sironeko@example.org
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDIN Object</h4>
                <p class = 'description'>
                    Similarly, In Ruby version of Sisimai,
                    <kbd>dump()</kbd> and <kbd>make()</kbd> methods of Sisimai class
                    read bounce mail data from Standard-In when a <kbd>STDIN</kbd> object
                    is specified as the first argument.
                </p>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -Ilib -rsisimai -e 'puts Sisimai.dump(STDIN)' | jq</kbd>
[
  {
    "catch": "",
    "token": "d295b517a3ad6f8748031e1068e07ebd089c0277",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -rsisimai -e 'p Sisimai.make(STDIN)'</kbd>
[#&lt;Sisimai::Data:0x007fa1b0993050 @addresser=#&lt;Sisimai::Address:0x007fa1b0990e40 @user="kijitora", ...
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

    </div>
</section> <!-- /#stdin -->

<section id = 'delivered'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-truck'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>Include Delivery Success</h2>
                <p class = 'description'>
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods return the parsed results
                    including a delivery success (delivery notification) when
                    <kbd>delivered</kbd> option is specified as the 2nd argument.
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Succeeded Delivery as a Sample</h3>
                <p class = 'description'>
                    <img class = 'lhs' src = '/static/images/icon/message-3.png'>
                    An email as a sample that has delivered successfully is available as
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/rfc3464-28.eml' target = 'new'>
                        rfc3464-28.eml
                    </a> at 
                    <a href = 'https://github.com/sisimai/set-of-emails' target = 'new'>github.com/sisimai/set-of-emails</a>
                    repository.
                    The following codes show a sample for parsing the email.
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered =&gt; 1</h4>
                <p class = 'description'>
                    When <kbd>delivered =&gt; 1</kbd> is specified as the 2nd argument of
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods,
                    an email that has delivered successfully is included in the parsed results.
                    If the value of <kbd>delivered</kbd> is <kbd>0</kbd>, <kbd>""</kbd> or <kbd>undef</kbd>,
                    Sisimai does not generate the parsed results from the succeeded email.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/rfc3464-28.eml';
my $v = Sisimai->make($f, <strong>'delivered' => 1</strong>);
for my $e ( @$v ) {
    print $e->action;           # deliverable
    print $e->deliverystatus;   # 2.1.5
    print $e->reason;           # delivered
    print $e->diagnosticcode;   # 250 2.1.5 Ok
    print $e->softbounce;       # -1
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered: true</h4>
                <p class = 'description'>
                    Similarly, In Ruby version of Sisimai, 
                    when <kbd>delivered: true</kbd> is specified as the 2nd argument of
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods,
                    an email that has delivered successfully is included in the parsed results.
                    If the value of <kbd>delivered</kbd> is <kbd>nil</kbd> or <kbd>false</kbd>,
                    Sisimai does not generate the parsed results from the succeeded email.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/rfc3464-28.eml'
v = Sisimai.make(f, <strong>delivered: true</strong>)
v.each do |e|
  puts e.action         # deliverable
  puts e.deliverystatus # 2.1.5
  puts e.reason         # delivered
  puts e.diagnosticcode # 250 2.1.5 Ok
  puts e.softbounce     # -1
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#delivered -->

<section id = 'othersrc' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-truck'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>Parse Except Mails</h2>
                <p class = 'description'>
                    Sisimai can parse bounce data except emails using <kbd>input</kbd> as the 2nd argument
                    of <kbd>make()</kbd> and <kbd>dump()</kbd> methods.
                    This feature has implemented at Sisimai v.20.0.
                    As of present, only bounce objects retrieved from Amazon SES
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-amazonses-01.json' target = 'new'>
                        (Bounce object thet can be got from SNS)
                    </a> and SendGrid 
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-sendgrid-01.json' target = 'new'>
                        (Bounce object that can be got with Web API)
                    </a>
                    could be parsed
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Bounce Object(JSON)</h3>
                <p class = 'description'>
                    <img class = 'lhs' src = '/static/images/icon/message-3.png'>
                    Some JSON files including bounce object retrieved from Cloud Email Delivery Services
                    (Amazon SES and SendGrid) are available in <strong>jsonobj/</strong> directory of
                    <a href = 'https://github.com/sisimai/set-of-emails' target = 'new'>github.com/sisimai/set-of-emails</a>
                    repository. The following codes show a sample for parsing
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-sendgrid-03.json' target = 'new'>
                        json-sendgrid-03.json
                    </a>(Bounce object from SendGrid).
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>input =&gt; 'json'</h4>
                <p class = 'description'>
                    When you set a decoded JSON (bounce object) to the 1st argument of,
                    set <kbd>input =&gt; 'json'</kbd> to the 2nd argument of
                    <kbd>make()</kbd> and <kbd>dump()</kbd> method of Sisimai,
                    you can get the parsed results.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
use JSON;
my $q = '[{"status": "5.1.1", "created": "2011-10-08 14:05:44", "reason": "550...';
my $j = JSON->new;
my $v = Sisimai->make($j->decode($q), <strong>'input' => 'json'</strong>);
for my $e ( @$v ) {
    print $e->smtpagent;        # JSON::SendGrid
    print $e->deliverystatus;   # 5.1.1
    print $e->reason;           # userunknown
    print $e->diagnosticcode;   # 550 5.1.1 The email account that you tried to...
    print $e->softbounce;       # 0
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>input: 'json'</h4>
                <p class = 'description'>
                    Like the perl version,
                    when you set a decoded JSON (bounce object) to the 1st argument of,
                    set <kbd>input: 'json'</kbd> to the 2nd argument of
                    <kbd>make()</kbd> and <kbd>dump()</kbd> method of Sisimai,
                    you can get the parsed results.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
require 'json'
q = '[{"status": "5.1.1", "created": "2011-10-08 14:05:44", "reason": "550...'
v = Sisimai.make(JSON.load(q), <strong>input: 'json'</strong>)
v.each do |e|
  puts e.smtpagent      # JSON::SendGrid
  puts e.deliverystatus # 5.1.1
  puts e.reason         # userunknown
  puts e.diagnosticcode # 550 5.1.1 The email account that you tried to...
  puts e.softbounce     # 0
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#othersrc -->

<section id = 'callback' class = ''>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-reply-all'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2>Callback Feature</h2>
                <p class = 'description'>
                    Beginning with {{ site.html.ss }} 4.19.0, Callback feature has implemented.
                    This feature allows you to read the header part and the body part of each
                    bounce mail before being parsed by Sisimai, and receive the results returned from
                    a hook method you specified via <kbd>catch()</kbd> method of <kbd>Sisimai::Data</kbd>
                    or <kbd>Sisimai::Message</kbd> object.
                </p>
                <p class = 'description'>
                    It is useful to get entire text of the original message, 
                    or the value of a certain header of the original message such as
                    a delivery ID, X-Mailer, and so on.
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>argv</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Argument of Hook Method</h3>
                <p class = 'description'>
                    A hook method in Perl (sub routine) receives a <strong>Hash reference</strong>,
                    a hook method in Ruby receives a <strong>Hash object</strong>.
                    Hash reference and object have the following structure.
                </p>
                <div class = 'table-responsive'>
                    <table class = 'table table-hover table-bordered'>
                        <thead>
                            <tr>
                                <th>Key Name</th>
                                <th>Data Type</th>
                                <th>Description</th>
                                <th>Email</th>
                                <th>JSON</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class = 'ltext'>datasrc</td>
                                <td>String</td>
                                <td>Kind of data source to be parsed</td>
                                <td>Available (email)</td>
                                <td>Available (json)</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>headers</td>
                                <td>Hash</td>
                                <td>Header part of a bounce mail (as a Hash Data)</td>
                                <td>Available</td>
                                <td>undef, nil</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>message</td>
                                <td>String</td>
                                <td>
                                    Body part of a bounce mail including the original 
                                    message
                                </td>
                                <td>Available</td>
                                <td>undef, nil</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>bounces</td>
                                <td>Hash or Array</td>
                                <td>
                                    Bounce object (Decoded JSON)
                                </td>
                                <td>undef, nil</td>
                                <td>Available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>email-postfix-16.eml</h3>
                <p class = 'description'>
                    The following codes show an example for getting the following values
                    from
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/email-postfix-16.eml' target = 'new'>
                        email-postfix-16.eml
                    </a>
                    using a hook method given as the 2nd argument of <kbd>make()</kbd>
                    method of Sisimai.
                </p>
                <ul>
                    <li>The value of <kbd>Received-SPF</kbd> in the header part</li>
                    <li>The value of <kbd>X-Postfix-Queue-ID</kbd> in the message body</li>
                </ul>

                <pre class = 'prettyprint'>Return-Path: &lt;&gt;
Received: by 192.0.2.22 with SMTP id fffffff000;
    Thu, 20 Jan 2011 23:34:45 +0900 (JST)
Received: from mx0.example.jp (mx0.example.jp [192.0.2.9])
    by mx.example.org with ESMTP id 0000000000000000000000;
    Thu, 20 Jan 2011 23:34:45 +0900 (JST)
<strong>Received-SPF: pass (example.org: best guess record for domain of mx0.example.jp designates 192.0.2.9 as permitted sender) client-ip=192.0.2.9;</strong>
Received: by mx0.example.jp (Postfix)
    id FFFFFFFFFFFF; Thu, 20 Jan 2011 23:34:45 +0900 (JST)
Date: Thu, 20 Jan 2011 23:34:45 +0900 (JST)
From: MAILER-DAEMON@example.jp (Mail Delivery System)
Subject: Undelivered Mail Returned to Sender
To: shironeko@cat.example.com
Auto-Submitted: auto-replied
MIME-Version: 1.0
Content-Type: multipart/report; report-type=delivery-status;
    boundary="FFFFFFFFFF.00000000/mx0.example.jp"
Content-Transfer-Encoding: 8bit
Message-Id: &lt;000000000000000.FFFFFFFFFFFF@mx0.example.jp&gt;

This is a MIME-encapsulated message.

--FFFFFFFFFF.00000000/mx0.example.jp
Content-Description: Notification
Content-Type: text/plain; charset=us-ascii

This is the mail system at host mx0.example.jp.

I'm sorry to have to inform you that your message could not
be delivered to one or more recipients. It's attached below.

For further assistance, please send mail to &lt;postmaster&gt;

If you do so, please include this problem report. You can
delete your own text from the attached returned message.

                   The mail system

&lt;kijitora@example.go.jp&gt;: host mx1.example.go.jp[192.0.2.127] said: 550 5.1.6 recipient
    no longer on server: kijitora@example.go.jp (in reply to RCPT TO command)

--FFFFFFFFFF.00000000/mx0.example.jp
Content-Description: Delivery report
Content-Type: message/delivery-status

Reporting-MTA: dns; mx0.example.jp
<strong>X-Postfix-Queue-ID: FFFFFF000000</strong>
X-Postfix-Sender: rfc822; shironeko@cat.example.com
...
                </pre>

                <p class = 'description'>
                    The following is an example of an argument that the hook method you defined
                    receives.
                    The argument have the header part (Hash) and the body part (String) generated from
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/email-postfix-16.eml' target = 'new'>
                        email-postfix-16.eml
                    </a>.
                </p>

                <pre class = 'prettyprint'>{
  <strong>'bounces'</strong> => undef,
  <strong>'datasrc'</strong> => 'email',
  <strong>'headers'</strong> => {
     'x-mailer' => undef,
     'return-path' => '<>',
     'content-type' => 'multipart/report; report-type=delivery-status; boundary="FFFFFFFFFF.00000000/mx0.example.jp"',
     'subject' => 'Undelivered Mail Returned to Sender',
     'date' => 'Thu, 20 Jan 2011 23:34:45 +0900 (JST)',
     'to' => 'shironeko@cat.example.com',
     'received-spf' => 'pass (example.org: best guess record for domain of mx0.example.jp designates 192.0.2.9 as permitted sender) client-ip=192.0.2.9;',
     'reply-to' => undef,
     'message-id' => '<000000000000000.FFFFFFFFFFFF@mx0.example.jp>',
     'from' => 'MAILER-DAEMON@example.jp (Mail Delivery System)',
     'content-transfer-encoding' => '8bit',
     'received' => [
         'by 192.0.2.22 with SMTP id fffffff000; Thu, 20 Jan 2011 23:34:45 +0900 (JST)',
         'from mx0.example.jp (mx0.example.jp [192.0.2.9]) by mx.example.org with ESMTP id 0000000000000000000000; Thu, 20 Jan 2011 23:34:45 +0900 (JST)',
         'by mx0.example.jp (Postfix) id FFFFFFFFFFFF; Thu, 20 Jan 2011 23:34:45 +0900 (JST)'
       ],
     'auto-submitted' => 'auto-replied'
     },
  <strong>'message'</strong> => 'This is a MIME-encapsulated message.
...
Reporting-MTA: dns; mx0.example.jp
X-Postfix-Queue-ID: FFFFFF000000
X-Postfix-Sender: rfc822; shironeko@cat.example.com
Arrival-Date: Thu, 20 Jan 2011 23:34:45 +0900 (JST)

Final-Recipient: rfc822; kijitora@example.go.jp
Action: failed
Status: 5.1.6
...
Subject: Nyaaaaan
To: Kijitora <kijitora@example.go.jp>
Message-Id: <0000000000000.FFFFFF000000@mx0.example.jp>

Nyaaaan
'
  }
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai-&gt;make($f, 'hook' => $x, 'field' => [])</h4>
                <p class = 'description'>
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods of Sisimai class
                    receive a code reference for being executed as the 2nd argument
                    <kbd>hook</kbd> like the following code:
                </p>
                <p class = 'description'>
                    Argument <kbd>field</kbd> receives an email header list as an array reference
                    which you want to capture in the hook method.
                    This argument is implemented at Sisimai 4.20.2.
                </p>
                <pre class = 'prettyprint'><strong>#! /usr/bin/env perl</strong>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/email-sendmail-24.eml';
my $x = sub {
    my $argv = shift;
    my $data = { 'queue-id' => '', 'received-spf' => '' };

    $data->{'received-spf'} = $argv->{'headers'}->{'received-spf'} || '';
    if( $argv->{'message'} =~ m/^X-Postfix-Queue-ID:\s*(.+)$/m ) {
        $data->{'queue-id'} = $1;
    }
    return $data;
};
my $h = ['Received-SPF'];
my $j = Sisimai-&gt;dump($f, <strong>'hook' => $x, 'field' => $h</strong>); # JSON文字列を得る
my $v = Sisimai-&gt;make($f, <strong>'hook' => $x, 'field' => $h</strong>);
print $v->[0]->{<strong>'catch'</strong>}->{'received-spf'};  # pass (example.org:...
print $v->[0]->{<strong>'catch'</strong>}->{'queue-id'};      # FFFFFF000000
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai.make(f, hook: x, field: h)</h4>
                <p class = 'description'>
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods of Sisimai class
                    receive a Proc object for being executed as the 2nd argument
                    <kbd>hook:</kbd> like the following code:
                </p>
                <p class = 'description'>
                    Argument <kbd>field:</kbd> receives an email header list as an array reference
                    which you want to capture in the hook method.
                    This argument is implemented at Sisimai 4.20.2.
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/email-postfix-16.eml'
x = lambda do |argv|
  data = { 'queue-id' => '', 'received-spf' => '' }

  data['received-spf'] = argv['headers']['received-spf'] || ''
  if cv = argv['message'].match(/^X-Postfix-Queue-ID:\s*(.+)$/)
    data['queue-id'] = cv[1]
  end
  return data
end

h = ['Received-SPF']
j = Sisimai.dump(f, <strong>hook: x, field: h</strong>)    # JSON文字列を得る
v = Sisimai.make(f, <strong>hook: x, field: h</strong>)
puts v[0][<strong>'catch'</strong>]['received-spf'] # pass (example.org: ...
puts v[0][<strong>'catch'</strong>]['queue-id']     # FFFFFF000000
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>JSON string by dump()</h3>
                <p class = 'description'>
                    JSON string generated by <kbd>dump()</kbd> method of Sisimai with
                    a hook method is like the following:
                </p>
                <pre class = 'prettyprint'>[
  {
    "timestamp": 1270043983,
    "smtpcommand": "RCPT",
    "subject": "Nyaaan",
    "recipient": "kijitora@example.jp",
    "destination": "example.jp",
    "senderdomain": "example.co.jp",
    "token": "bb2a5dfb6161f396300b24acd9bf637c1c45a58a",
    "smtpagent": "qmail",
    "replycode": "450",
    "softbounce": 1,
    <strong>"catch": {
      "received-spf": "pass (example.org: best guess record for domain of mx0.example.jp designates 192.0.2.9 as permitted sender) client-ip=192.0.2.9;",
      "queue-id": "FFFFFF000000",
    },</strong>
    "rhost": "192.0.2.135",
    "timezoneoffset": "+0900",
    "addresser": "shironeko@example.co.jp",
    "diagnostictype": "SMTP",
    "action": "failed",
    "listid": "",
    "feedbacktype": "",
    "diagnosticcode": "192.0.2.135 does not like recipient. Remote host said: 450 4.2.2 <kijitora@example.jp>... Mailbox Full Giving up on 192.0.2.135. I'm not going to try again; this message has been in the queue too long.",
    "reason": "mailboxfull",
    "deliverystatus": "4.2.2",
    "alias": "",
    "lhost": "",
    "messageid": "57D03121-12F7-4801-B30F-9E44B15E56DC@example.co.jp"
  }
]
                </pre>

            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>Ojbect</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>Bounce Object: json-amazonses-01.eml</h3>
                <p class = 'description'>
                    The following codes show an example for getting value of <kbd>mail.sendingAccountId</kbd>
                    from a bounce object (retrieved or notified from AWS SNS)
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-amazonses-01.json' target = 'new'>
                        json-amazonses-01.json
                    </a> using a hook method given as the 2nd argument of <kbd>make()</kbd> method of Sisimai.
                </p>
                <pre class = 'prettyprint'>{
  "notificationType": "Bounce",
  "bounce": {
    "bounceType": "Permanent",
    "bounceSubType": "General",
    "bouncedRecipients": [
      {
        "emailAddress": "bounce@simulator.amazonses.com",
        "action": "failed",
        "status": "5.1.1",
        "diagnosticCode": "smtp; 550 5.1.1 user unknown"
      }
    ],
    "timestamp": "2016-10-21T00:06:40.502Z",
    "feedbackId": "01010157e48fa03f-c7e948fe-3c34-403e-b681-02a497797067-000000",
    "reportingMTA": "dsn; a27-23.smtp-out.us-west-2.amazonses.com"
  },
  "mail": {
    "timestamp": "2016-10-21T00:06:39.000Z",
    "source": "kijitora@neko.example.org",
    <strong>"sourceArn": "arn:aws:ses:us-west-2:123456789012:identity/kijitora@neko.example.org",</strong>
    "sendingAccountId": "123456789012",
    ...
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
                <p class = 'description'>
                    The following is an example of an argument that the hook method you defined receives.
                    The argument have a bounce object (decoded JSON) in "bounces" key decoded from 
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-amazonses-01.json' target = 'new'>
                        json-amazonses-01.json
                    </a>.
                </p>

                <pre class = 'prettyprint'>{
    <strong>'datasrc'</strong> => 'json',
    <strong>'headers'</strong> => undef,
    <strong>'message'</strong> => undef,
    <strong>'bounces'</strong> => {
        'bounce' => {
            'feedbackId' => '01010157e48fa03f-c7e948fe-3c34-403e-b681-02a497797067-000000',
            'timestamp' => '2016-10-21T00:06:40.502Z',
            'reportingMTA' => 'dsn; a27-23.smtp-out.us-west-2.amazonses.com',
            'bounceType' => 'Permanent',
        },
        'mail' => {
            'source' => 'kijitora@neko.example.org',
            'sendingAccountId' => '123456789012',
            'destination' => [
                'bounce@simulator.amazonses.com'
            ],
            'timestamp' => '2016-10-21T00:06:39.000Z',
            'sourceArn' => 'arn:aws:ses:us-west-2:123456789012:identity/kijitora@neko.example.org',
            'messageId' => '01010157e48f9b9b-891e9a0e-9c9d-4773-9bfe-608f2ef4756d-000000'
        },
        'notificationType' => 'Bounce'
    }
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai-&gt;make($f, 'hook' => $x, 'input' => 'json')</h4>
                <p class = 'description'>
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods of Sisimai class receive a code
                    reference for being executed as the 2nd argument <kbd>hook</kbd> like the following
                    code:
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
use JSON;
my $q = '{"notificationType": "Bounce", "bounce": {...';
my $o = JSON->new;
my $x = sub {
    my $argv = shift;
    my $data = { 'account-id' => '' };

    $data->{'account-id'} = $argv->{'bounces'}->{'mail'}->{'sendingAccountId'};
    return $data;
};
my $j = Sisimai-&gt;dump($o->decode($q), <strong>'hook' => $x</strong>, 'input' => 'json'); # get JSON string
my $v = Sisimai-&gt;make($o->decode($q), <strong>'hook' => $x</strong>, 'input' => 'json');
print $v->[0]->{<strong>'catch'</strong>}->{'account-id'};  # 123456789012
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai.make(f, hook: x, input: 'json')</h4>
                <p class = 'description'>
                    <kbd>make()</kbd> and <kbd>dump()</kbd> methods of Sisimai class receive a Proc
                    object for being executed as the 2nd argument <kbd>hook:</kbd> like the
                    following code:
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
require 'json'
q = '{"notificationType": "Bounce", "bounce": {...'
o = JSON.load(q)
x = lambda do |argv|
  data = { 'acount-id' => nil }

  data['account-id'] = argv['bounces']['mail']['sendingAccountId']
  return data
end

j = Sisimai.dump(o, <strong>hook: x</strong>, input: 'json')  # get JSON string
v = Sisimai.make(o, <strong>hook: x</strong>, input: 'json')
puts v[0][<strong>'catch'</strong>]['account-id']  # 123456789012
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>JSON string by dump()</h3>
                <p class = 'description'>
                    JSON string generated by <kbd>dump()</kbd> method of Sisimai
                    with a hook method is like the following:
                </p>
                <pre class = 'prettyprint'>
[
  {
    "timezoneoffset": "+0900",
    "reason": "userunknown",
    "replycode": "550",
    "messageid": "01010157e48f9b9b-891e9a0e-9c9d-4773-9bfe-608f2ef4756d-000000",
    "lhost": "a27-23.smtp-out.us-west-2.amazonses.com",
    "destination": "simulator.amazonses.com",
    "senderdomain": "neko.example.org",
    "diagnosticcode": "550 5.1.1 user unknown",
    "addresser": "kijitora@neko.example.org",
    <strong>"catch": {
      "account-id": 123456789012
    },</strong>
    "subject": "nyaan",
    "deliverystatus": "5.1.1",
    "token": "79f14902d1e4b8f9c40727609d7a752a1700564e",
    "feedbacktype": "",
    "softbounce": 0,
    "rhost": "",
    "smtpcommand": "",
    "smtpagent": "JSON::AmazonSES",
    "recipient": "bounce@simulator.amazonses.com",
    "alias": "",
    "diagnostictype": "SMTP",
    "listid": "",
    "action": "failed",
    "timestamp": 1476976000
  }
]
                </pre>

            </div>
        </div>

    </div>
</section> <!-- #callback -->

