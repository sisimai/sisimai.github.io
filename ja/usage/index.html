---
"layout": "document"
"directory": "usage/"
"title": "Sisimaiでの解析方法"
"description": "Sisimaiの解析方法・オプション・コールバック機能"
"author": "azumakuniyuki"
---

<a id = 'tohash' href = '#'></a>
<header id = 'home'>
    <div class = 'main-nav'>
        <div class = 'container'>
            <div class = 'navbar-header'>
                <button type = 'button' class = 'navbar-toggle' data-toggle = 'collapse' data-target = '.navbar-collapse'>
                    <span class = 'sr-only'>Toggle navigation</span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                    <span class = 'icon-bar'></span>
                </button>
                <a class = 'navbar-brand' href = 'https://libsisimai.org/'>
                    <h1>
                        <img class = 'img-responsive' src = '/static/images/logo/sisimai-logotype-w11.png' 
                            width = '144' alt = 'Sisimai: Mail Analyzing Interface'>
                    </h1>
                </a>
            </div>
            <div class = 'collapse navbar-collapse'>
                <ul class = 'nav navbar-nav navbar-right'>
                    <li class = 'scroll'><a href = 'https://libsisimai.org/ja/'><i class = 'fa fa-home'></i></a></li> 
                    <li class = 'scroll active'><a href = '#index'><i class = 'fa fa-arrow-circle-up'></i></a></li> 
                    <li class = 'scroll'><a href = '#stdin'>標準入力</a></li>
                    <li class = 'scroll'><a href = '#delivered'>配信成功も</a></li>
                    <li class = 'scroll'><a href = '#othersrc'>メール以外</a></li>
                    <li class = 'scroll'><a href = '#callback'>コールバック</a></li>
                    <li class = 'others'><a href = '/ja/docs/'>ドキュメント</a></li>
                    <li class = 'others'><a href = '/en/usage/'><i class = 'fa fa-language'></i></a></li>
                </ul>
            </div>
        </div>
    </div> <!-- /#main-nav -->
</header> <!-- /#home -->

<section id = 'index'>
    <div class = 'container'>
        <div class = 'heading'>
            <div class = 'row'>
                <div class = 'text-center col-sm-8 col-sm-offset-2'>
                    <img src = '/static/images/logo/sisimai-x01.png' width = '20%'>
                    <h2>シシマイでの解析方法</h2>
                </div>
            </div>
        </div>
        <div class = 'text-center index-table'>
            <div class = 'row'>
                <div class = 'col-sm-1'></div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-keyboard-o'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>基本的な使い方</h3>
                        <p class = 'description ja'>
                            メールの解析、構造化されたデータやJSON文字列の取得化など、
                            簡単な使い方を紹介します。
                        </p>
                    </div>
                    <a href = '/ja/start/#usage' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-desktop'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>標準入力を読む</h3>
                        <p class = 'description ja'>
                            標準入力(STDIN)からバウンスメールのデータを読み込み
                            シシマイで解析する方法の記述例です。
                        </p>
                    </div>
                    <a href = '#stdin' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-truck'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>配信成功も含む</h3>
                        <p class = 'description ja'>
                            配信が成功したメール(配信通知)も解析結果に含める
                            {{ site.html.ss }}クラスのメソッド使用方法を紹介します。
                        </p>
                    </div>
                    <a href = '#delivered' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-files-o'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>メール以外</h3>
                        <p class = 'description ja'>
                            メール以外のデータソースでは、メール配信クラウドの
                            バウンスオブジェクトも解析することができます。
                        </p>
                    </div>
                    <a href = '#othersrc' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-2'>
                    <div class = 'index-icon'>
                        <i class = 'fa fa-reply-all'></i>
                    </div>
                    <div class = 'index-info'>
                        <h3>コールバック</h3>
                        <p class = 'description ja'>
                            コールバック機能を使うとシシマイが解析する前のデータ
                            に対して、独自の処理を行うことができます。
                        </p>
                    </div>
                    <a href = '#callback' class = 'btn btn-continue'>Read</a>
                </div>
                <div class = 'col-sm-1'></div>
            </div>
        </div>
    </div>
</section> <!-- /#index -->

<section id = 'stdin' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-desktop'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>標準入力から読む</h2>
                <hr>
                <p class = 'description ja'>
                    {{ site.html.ss }}(シシマイ)の<kbd>make()</kbd>や<kbd>dump()</kbd>メソッドは、
                    引数にファイル名を指定する以外に、<kbd>STDIN</kbd>を指定することによって、
                    標準入力(STDIN)からバウンスメールのデータを読み込むことができます。
                    この機能は初期の{{ site.html.ss }}から実装されていましたが、バグがあったため、
                    読み込みができない場合がありました。このバグはSisimai 4.18.1
                    <a href = 'https://github.com/sisimai/p5-Sisimai/issues/194' target = 'new'>
                    (Perl版)
                    </a>
                    <a href = 'https://github.com/sisimai/rb-Sisimai/issues/61' target = 'new'>
                    (Ruby版)
                    </a>
                    にて修正済みです。
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDINファイルハンドル</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>dump()</kbd>と<kbd>make()</kbd>メソッドは、
                    第一引数にファイルハンドル<kbd>STDIN</kbd>を指定すると、
                    標準入力からバウンスメールのデータを読み込み、解析結果を返します。
                </p>

                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print Sisimai->dump(STDIN)' | jq</kbd>
[
  {
    "listid": "",
    "smtpagent": "Sendmail",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | perl -MSisimai -lE 'print $_->recipient->address for @{ Sisimai->make(STDIN) }'</kbd>
kijitora@example.jp
sironeko@example.org
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>STDINオブジェクト</h4>
                <p class = 'description ja'>
                    Ruby版{{ site.html.ss }}も同様に、Sisimaiクラスの<kbd>dump()</kbd>と<kbd>make()</kbd>メソッドの
                    第一引数に<kbd>STDIN</kbd>オブジェクトを指定すると、
                    標準入力からバウンスメールのデータを読み込み、解析結果を返します。
                </p>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -Ilib -rsisimai -e 'puts Sisimai.dump(STDIN)' | jq</kbd>
[
  {
    "catch": "",
    "token": "d295b517a3ad6f8748031e1068e07ebd089c0277",
    ...
                </pre>
                <pre class = 'prettyprint'>
% <kbd>cat ./path/to/email | ruby -rsisimai -e 'p Sisimai.make(STDIN)'</kbd>
[#&lt;Sisimai::Data:0x007fa1b0993050 @addresser=#&lt;Sisimai::Address:0x007fa1b0990e40 @user="kijitora", ...
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
            </div>
        </div>

    </div>
</section> <!-- /#stdin -->

<section id = 'delivered'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-truck'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>配信成功も解析結果に含める</h2>
                <p class = 'description ja'>
                    Sisimaiの<kbd>make()</kbd>と<kbd>dump()</kbd>は第二引数に<kbd>delivered</kbd>
                    を指定することによって、配信が成功した事を通知するメールも解析結果に含めることができます。
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>配信成功のサンプルメール</h3>
                <p class = 'description ja'>
                    <img class = 'lhs' src = '/static/images/icon/message-3.png'>
                    配送が成功したメールは
                    <a href = 'https://github.com/sisimai/set-of-emails' target = 'new'>github.com/sisimai/set-of-emails</a>
                    リポジトリの
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/rfc3464-28.eml' target = 'new'>
                        rfc3464-28.eml
                    </a>
                    がサンプルとして用意してあります。
                    ここでは、このメールを解析するサンプルコードを紹介します。
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered =&gt; 1</h4>
                <p class = 'description ja'>
                    <kbd>make()</kbd>と<kbd>dump()</kbd>の第二引数に<kbd>delivered =&gt; 1</kbd>を指定すると、
                    配信に成功したメール(配信通知)も解析結果に含まれるようになります。<kbd>delivered</kbd>
                    に偽となる値(0,undef,'')を指定した場合は、解析結果は生成されません。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/rfc3464-28.eml';
my $v = Sisimai->make($f, <strong>'delivered' => 1</strong>);
for my $e ( @$v ) {
    print $e->action;           # deliverable
    print $e->deliverystatus;   # 2.1.5
    print $e->reason;           # delivered
    print $e->diagnosticcode;   # 250 2.1.5 Ok
    print $e->softbounce;       # -1
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>delivered: true</h4>
                <p class = 'description ja'>
                    Perl版と同様に、Ruby版{{ site.html.ss }}でも<kbd>make()</kbd>と<kbd>dump()</kbd>の第二引数に
                    <kbd>delivered: true</kbd>を指定すると、配信に成功したメール(配信通知)も
                    解析結果に含まれるようになります。<kbd>delivered</kbd>
                    に偽となる値(nil,false)を指定した場合は、解析結果は生成されません。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/rfc3464-28.eml'
v = Sisimai.make(f, <strong>delivered: true</strong>)
v.each do |e|
  puts e.action         # deliverable
  puts e.deliverystatus # 2.1.5
  puts e.reason         # delivered
  puts e.diagnosticcode # 250 2.1.5 Ok
  puts e.softbounce     # -1
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#delivered -->

<section id = 'othersrc' class = 'parallax'>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-truck'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2 class = 'in-desc'>メール以外を解析する</h2>
                <p class = 'description ja'>
                    Sisimaiの<kbd>make()</kbd>と<kbd>dump()</kbd>は第二引数に<kbd>input</kbd>
                    を指定することによって、メール以外のバウンス記録を解析することができます。
                    この機能は{{ site.html.ss }} 4.20.0で実装されました。現時点で解析できるものは
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-amazonses-01.json' target = 'new'>
                        SNSで取得できるAmazon SESのバウンスオブジェクト
                    </a>と、
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-sendgrid-01.json' target = 'new'>
                        用意されているWeb APIで取得できるSendGridのバウンスオブジェクト
                    </a>
                    のみです。
                </p>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>バウンスオブジェクト(JSON)</h3>
                <p class = 'description ja'>
                    <img class = 'lhs' src = '/static/images/icon/message-3.png'>
                    メール配信クラウド(Amazon SESとSendGrid)から取得したバウンスオブジェクトのJSONファイルは
                    <a href = 'https://github.com/sisimai/set-of-emails' target = 'new'>github.com/sisimai/set-of-emails</a>
                    リポジトリの<strong>jsonobj/</strong>ディレクトリに何種類かを用意してあります。
                    ここでは、
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-sendgrid-03.json' target = 'new'>
                        json-sendgrid-03.json
                    </a>(SendGridのバウンスオブジェクト)を解析するコードを紹介します。
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>input =&gt; 'json'</h4>
                <p class = 'description ja'>
                    <kbd>make()</kbd>と<kbd>dump()</kbd>の第一引数にデコードしたJSON(バウンスオブジェクト)を、
                    第二引数に<kbd>input =&gt; 'json'</kbd>をそれぞれ指定すると、バウンスオブジェクトを解析して
                    {{ site.html.ss }}の形式として解析結果を得られます。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
use JSON;
my $q = '[{"status": "5.1.1", "created": "2011-10-08 14:05:44", "reason": "550...';
my $j = JSON->new;
my $v = Sisimai->make($j->decode($q), <strong>'input' => 'json'</strong>);
for my $e ( @$v ) {
    print $e->smtpagent;        # JSON::SendGrid
    print $e->deliverystatus;   # 5.1.1
    print $e->reason;           # userunknown
    print $e->diagnosticcode;   # 550 5.1.1 The email account that you tried to...
    print $e->softbounce;       # 0
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>input: 'json'</h4>
                <p class = 'description ja'>
                    Perl版と同様に、Ruby版{{ site.html.ss }}でも<kbd>make()</kbd>と<kbd>dump()</kbd>の第一引数に
                    JSONオブジェクト(バウンスオブジェクトのJSONをデコードしたもの)を、
                    第二引数に<kbd>input: 'json'</kbd>を指定すると、JSON形式のバウンスオブジェクトも
                    解析できます。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
require 'json'
q = '[{"status": "5.1.1", "created": "2011-10-08 14:05:44", "reason": "550...'
v = Sisimai.make(JSON.load(q), <strong>input: 'json'</strong>)
v.each do |e|
  puts e.smtpagent      # JSON::SendGrid
  puts e.deliverystatus # 5.1.1
  puts e.reason         # userunknown
  puts e.diagnosticcode # 550 5.1.1 The email account that you tried to...
  puts e.softbounce     # 0
end
                </pre>
            </div>
        </div>
    </div>
</section> <!-- /#othersrc -->

<section id = 'callback' class = ''>
    <div class = 'container'>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'post-it'>
                    <i class = 'fa fa-reply-all'></i>
                </div>
            </div>
            <div class = 'heading col-sm-8 col-sm-offset-0'>
                <h2>コールバック機能</h2>
                <p class = 'description ja'>
                    {{ site.html.ss }} 4.19.0から実装されたコールバック機能を使用すると、
                    <kbd>Sisimai::Data</kbd>または<kbd>Sisimai::Message</kbd>の<kbd>catch()</kbd>
                    メソッドを通して、バウンスメールを独自に処理した結果を取得することができます。
                    この機能は{{ site.html.ss }}が解析結果に含めない元メッセージ全体や
                    元メッセージの特定のヘッダの値(例えば配信IDなど)を取り出したりするのに便利です。
                </p>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>argv</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>呼び出されるメソッドの引数</h3>
                <p class = 'description ja'>
                    Perlのフックメソッド(サブルーチン)には<strong>ハッシュリファレンス1つ</strong>、
                    Rubyのフックメソッドには<strong>Hashオブジェクト1つ</strong>
                    が引数として渡されます。引数の構造は以下のようになっています。
                </p>
                <div class = 'table-responsive'>
                    <table class = 'table table-hover table-bordered'>
                        <thead>
                            <tr>
                                <th>キー名</th>
                                <th>データ型</th>
                                <th>説明</th>
                                <th>メール</th>
                                <th>JSON</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class = 'ltext'>datasrc</td>
                                <td>String</td>
                                <td>解析対象データの種類</td>
                                <td>○ (email)</td>
                                <td>○ (json)</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>headers</td>
                                <td>Hash</td>
                                <td>バウンスメールのヘッダ部分(ハッシュ化済み)</td>
                                <td>○</td>
                                <td>undef,nil</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>message</td>
                                <td>String</td>
                                <td>バウンスメールのメール本文(改行・元メッセージを含む)</td>
                                <td>○</td>
                                <td>undef,nil</td>
                            </tr>
                            <tr>
                                <td class = 'ltext'>bounces</td>
                                <td>Hash or Array</td>
                                <td>バウンスオブジェクト(Decoded JSON)</td>
                                <td>undef,nil</td>
                                <td>○</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>email</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>電子メール: email-postfix-16.eml</h3>
                <p class = 'description ja'>
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/email-postfix-16.eml' target = 'new'>
                        email-postfix-16.eml
                    </a>にある以下の内容をコールバックで実行するコードによって取得する例を示します。
                </p>
                <ul>
                    <li>ヘッダの<kbd>Received-SPF</kbd>の値</li>
                    <li>本文の<kbd>X-Postfix-Queue-ID</kbd>の値</li>
                </ul>

                <pre class = 'prettyprint'>Return-Path: &lt;&gt;
Received: by 192.0.2.22 with SMTP id fffffff000;
    Thu, 20 Jan 2011 23:34:45 +0900 (JST)
Received: from mx0.example.jp (mx0.example.jp [192.0.2.9])
    by mx.example.org with ESMTP id 0000000000000000000000;
    Thu, 20 Jan 2011 23:34:45 +0900 (JST)
<strong>Received-SPF: pass (example.org: best guess record for domain of mx0.example.jp designates 192.0.2.9 as permitted sender) client-ip=192.0.2.9;</strong>
Received: by mx0.example.jp (Postfix)
    id FFFFFFFFFFFF; Thu, 20 Jan 2011 23:34:45 +0900 (JST)
Date: Thu, 20 Jan 2011 23:34:45 +0900 (JST)
From: MAILER-DAEMON@example.jp (Mail Delivery System)
Subject: Undelivered Mail Returned to Sender
To: shironeko@cat.example.com
Auto-Submitted: auto-replied
MIME-Version: 1.0
Content-Type: multipart/report; report-type=delivery-status;
    boundary="FFFFFFFFFF.00000000/mx0.example.jp"
Content-Transfer-Encoding: 8bit
Message-Id: &lt;000000000000000.FFFFFFFFFFFF@mx0.example.jp&gt;

This is a MIME-encapsulated message.

--FFFFFFFFFF.00000000/mx0.example.jp
Content-Description: Notification
Content-Type: text/plain; charset=us-ascii

This is the mail system at host mx0.example.jp.

I'm sorry to have to inform you that your message could not
be delivered to one or more recipients. It's attached below.

For further assistance, please send mail to &lt;postmaster&gt;

If you do so, please include this problem report. You can
delete your own text from the attached returned message.

                   The mail system

&lt;kijitora@example.go.jp&gt;: host mx1.example.go.jp[192.0.2.127] said: 550 5.1.6 recipient
    no longer on server: kijitora@example.go.jp (in reply to RCPT TO command)

--FFFFFFFFFF.00000000/mx0.example.jp
Content-Description: Delivery report
Content-Type: message/delivery-status

Reporting-MTA: dns; mx0.example.jp
<strong>X-Postfix-Queue-ID: FFFFFF000000</strong>
X-Postfix-Sender: rfc822; shironeko@cat.example.com
...
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
                <p class = 'description ja'>
                    フックメソッドには一つの引数が以下のように渡されます。
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/maildir/bsd/email-postfix-16.eml' target = 'new'>
                        email-postfix-16.eml
                    </a>のヘッダ部分(ハッシュ化済み)とメッセージ部分(文字列)を構造化したものです。
                    <kbd>undef</kbd>になっている部分は、Rubyでは<kbd>nil</kbd>と読み替えてください。
                </p>

                <pre class = 'prettyprint'>{
  <strong>'bounces'</strong> => undef,
  <strong>'datasrc'</strong> => 'email',
  <strong>'headers'</strong> => {
     'x-mailer' => undef,
     'return-path' => '<>',
     'content-type' => 'multipart/report; report-type=delivery-status; boundary="FFFFFFFFFF.00000000/mx0.example.jp"',
     'subject' => 'Undelivered Mail Returned to Sender',
     'date' => 'Thu, 20 Jan 2011 23:34:45 +0900 (JST)',
     'to' => 'shironeko@cat.example.com',
     'received-spf' => 'pass (example.org: best guess record for domain of mx0.example.jp designates 192.0.2.9 as permitted sender) client-ip=192.0.2.9;',
     'reply-to' => undef,
     'message-id' => '<000000000000000.FFFFFFFFFFFF@mx0.example.jp>',
     'from' => 'MAILER-DAEMON@example.jp (Mail Delivery System)',
     'content-transfer-encoding' => '8bit',
     'received' => [
         'by 192.0.2.22 with SMTP id fffffff000; Thu, 20 Jan 2011 23:34:45 +0900 (JST)',
         'from mx0.example.jp (mx0.example.jp [192.0.2.9]) by mx.example.org with ESMTP id 0000000000000000000000; Thu, 20 Jan 2011 23:34:45 +0900 (JST)',
         'by mx0.example.jp (Postfix) id FFFFFFFFFFFF; Thu, 20 Jan 2011 23:34:45 +0900 (JST)'
       ],
     'auto-submitted' => 'auto-replied'
     },
  <strong>'message'</strong> => 'This is a MIME-encapsulated message.
...
Reporting-MTA: dns; mx0.example.jp
X-Postfix-Queue-ID: FFFFFF000000
X-Postfix-Sender: rfc822; shironeko@cat.example.com
Arrival-Date: Thu, 20 Jan 2011 23:34:45 +0900 (JST)

Final-Recipient: rfc822; kijitora@example.go.jp
Action: failed
Status: 5.1.6
...
Subject: Nyaaaaan
To: Kijitora <kijitora@example.go.jp>
Message-Id: <0000000000000.FFFFFF000000@mx0.example.jp>

Nyaaaan
'
  }
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai-&gt;make($f, 'hook' => $x, 'field' => [])</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>make()</kbd>と<kbd>dump()</kbd>メソッドに、
                    実行したい処理内容を書いたサブルーチンのコードリファレンスを第二引数
                    <kbd>hook</kbd>として渡すことができます。
                </p>
                <p class = 'description ja'>
                    また、ヘッダ部分から抽出したいヘッダがある場合は、ヘッダ名を引数<kbd>field</kbd>
                    に配列リファレンスで渡す必要があります。
                    この<kbd>field</kbd>引数はSisimai 4.20.2で実装されました。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
my $f = './set-of-emails/maildir/bsd/email-postfix-16.eml';
my $x = sub {
    my $argv = shift;
    my $data = { 'queue-id' => '', 'received-spf' => '' };

    $data->{'received-spf'} = $argv->{'headers'}->{'received-spf'} || '';
    if( $argv->{'message'} =~ m/^X-Postfix-Queue-ID:\s*(.+)$/m ) {
        $data->{'queue-id'} = $1;
    }
    return $data;
};
my $h = ['Received-SPF'];
my $j = Sisimai-&gt;dump($f, <strong>'hook' => $x, 'field' => $h</strong>); # JSON文字列を得る
my $v = Sisimai-&gt;make($f, <strong>'hook' => $x, 'field' => $h</strong>);
print $v->[0]->{<strong>'catch'</strong>}->{'received-spf'};  # pass (example.org:...
print $v->[0]->{<strong>'catch'</strong>}->{'queue-id'};      # FFFFFF000000
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai.make(f, hook: x, field: [])</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>make()</kbd>と<kbd>dump()</kbd>メソッドに、
                    実行したい処理内容を書いたProcオブジェクトを<kbd>hook:</kbd>
                    として渡すことができます。
                </p>
                <p class = 'description ja'>
                    また、ヘッダ部分から抽出したいヘッダがある場合は、ヘッダ名を引数<kbd>field:</kbd>
                    に配列で渡す必要があります。
                    この<kbd>field:</kbd>引数はSisimai 4.20.2で実装されました。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
f = './set-of-emails/maildir/bsd/email-postfix-16.eml'
x = lambda do |argv|
  data = { 'queue-id' => '', 'received-spf' => '' }

  data['received-spf'] = argv['headers']['received-spf'] || ''
  if cv = argv['message'].match(/^X-Postfix-Queue-ID:\s*(.+)$/)
    data['queue-id'] = cv[1]
  end
  return data
end

h = ['Received-SPF']
j = Sisimai.dump(f, <strong>hook: x, field: h</strong>)    # JSON文字列を得る
v = Sisimai.make(f, <strong>hook: x, field: h</strong>)
puts v[0][<strong>'catch'</strong>]['received-spf'] # pass (example.org: ...
puts v[0][<strong>'catch'</strong>]['queue-id']     # FFFFFF000000
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>dump()で出力したJSON</h3>
                <p class = 'description ja'>
                    Sisimaiの<kbd>dump()</kbd>メソッドにフックメソッドを渡して得たJSON文字列は
                    次のような内容になります。
                </p>
                <pre class = 'prettyprint'>[
  {
    "timestamp": 1270043983,
    "smtpcommand": "RCPT",
    "subject": "Nyaaan",
    "recipient": "kijitora@example.jp",
    "destination": "example.jp",
    "senderdomain": "example.co.jp",
    "token": "bb2a5dfb6161f396300b24acd9bf637c1c45a58a",
    "smtpagent": "qmail",
    "replycode": "450",
    "softbounce": 1,
    <strong>"catch": {
      "received-spf": "pass (example.org: best guess record for domain of mx0.example.jp designates 192.0.2.9 as permitted sender) client-ip=192.0.2.9;",
      "queue-id": "FFFFFF000000",
    },</strong>
    "rhost": "192.0.2.135",
    "timezoneoffset": "+0900",
    "addresser": "shironeko@example.co.jp",
    "diagnostictype": "SMTP",
    "action": "failed",
    "listid": "",
    "feedbacktype": "",
    "diagnosticcode": "192.0.2.135 does not like recipient. Remote host said: 450 4.2.2 <kijitora@example.jp>... Mailbox Full Giving up on 192.0.2.135. I'm not going to try again; this message has been in the queue too long.",
    "reason": "mailboxfull",
    "deliverystatus": "4.2.2",
    "alias": "",
    "lhost": "",
    "messageid": "57D03121-12F7-4801-B30F-9E44B15E56DC@example.co.jp"
  }
]
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>Ojbect</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>バウンスオブジェクト: json-amazonses-01.eml</h3>
                <p class = 'description ja'>
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-amazonses-01.json' target = 'new'>
                        json-amazonses-01.json
                    </a>内、SNSで取得できるバウンスオブジェクトから<kbd>mail.sendingAccountId</kbd>の値を、
                    コールバックで実行するコードで取得するサンプルコードで説明します。
                </p>
                <pre class = 'prettyprint'>{
  "notificationType": "Bounce",
  "bounce": {
    "bounceType": "Permanent",
    "bounceSubType": "General",
    "bouncedRecipients": [
      {
        "emailAddress": "bounce@simulator.amazonses.com",
        "action": "failed",
        "status": "5.1.1",
        "diagnosticCode": "smtp; 550 5.1.1 user unknown"
      }
    ],
    "timestamp": "2016-10-21T00:06:40.502Z",
    "feedbackId": "01010157e48fa03f-c7e948fe-3c34-403e-b681-02a497797067-000000",
    "reportingMTA": "dsn; a27-23.smtp-out.us-west-2.amazonses.com"
  },
  "mail": {
    "timestamp": "2016-10-21T00:06:39.000Z",
    "source": "kijitora@neko.example.org",
    <strong>"sourceArn": "arn:aws:ses:us-west-2:123456789012:identity/kijitora@neko.example.org",</strong>
    "sendingAccountId": "123456789012",
    ...
                </pre>
            </div>

            <div class = 'col-sm-8 col-sm-offset-2'>
                <p class = 'description ja'>
                    フックメソッドには一つの引数が以下のように渡されます。
                    <a href = 'https://github.com/sisimai/set-of-emails/blob/master/jsonobj/json-amazonses-01.json' target = 'new'>
                        json-amazonses-01.json
                    </a>のバウンスオブジェクト(JSON)をデコードして構造化したものです。
                    <kbd>undef</kbd>になっている部分は、Rubyでは<kbd>nil</kbd>と読み替えてください。
                </p>

                <pre class = 'prettyprint'>{
    <strong>'datasrc'</strong> => 'json',
    <strong>'headers'</strong> => undef,
    <strong>'message'</strong> => undef,
    <strong>'bounces'</strong> => {
        'bounce' => {
            'feedbackId' => '01010157e48fa03f-c7e948fe-3c34-403e-b681-02a497797067-000000',
            'timestamp' => '2016-10-21T00:06:40.502Z',
            'reportingMTA' => 'dsn; a27-23.smtp-out.us-west-2.amazonses.com',
            'bounceType' => 'Permanent',
        },
        'mail' => {
            'source' => 'kijitora@neko.example.org',
            'sendingAccountId' => '123456789012',
            'destination' => [
                'bounce@simulator.amazonses.com'
            ],
            'timestamp' => '2016-10-21T00:06:39.000Z',
            'sourceArn' => 'arn:aws:ses:us-west-2:123456789012:identity/kijitora@neko.example.org',
            'messageId' => '01010157e48f9b9b-891e9a0e-9c9d-4773-9bfe-608f2ef4756d-000000'
        },
        'notificationType' => 'Bounce'
    }
}
                </pre>
            </div>
        </div>

        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Perl</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai-&gt;make($f, 'hook' => $x, 'input' => 'json')</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>make()</kbd>と<kbd>dump()</kbd>メソッドに、
                    実行したい処理内容を書いたサブルーチンのコードリファレンスを第二引数
                    <kbd>hook</kbd>として渡すことができます。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env perl</span>
use Sisimai;
use JSON;
my $q = '{"notificationType": "Bounce", "bounce": {...';
my $o = JSON->new;
my $x = sub {
    my $argv = shift;
    my $data = { 'account-id' => '' };

    $data->{'account-id'} = $argv->{'bounces'}->{'mail'}->{'sendingAccountId'};
    return $data;
};
my $j = Sisimai-&gt;dump($o->decode($q), <strong>'hook' => $x</strong>, 'input' => 'json'); # JSON文字列を得る
my $v = Sisimai-&gt;make($o->decode($q), <strong>'hook' => $x</strong>, 'input' => 'json');
print $v->[0]->{<strong>'catch'</strong>}->{'account-id'};     # 123456789012
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-text'>Ruby</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h4 class = 'in-desc'>Sisimai.make(f, hook: x, input: 'json')</h4>
                <p class = 'description ja'>
                    Sisimaiクラスの<kbd>make()</kbd>と<kbd>dump()</kbd>メソッドに、
                    実行したい処理内容を書いたProcオブジェクトを
                    <kbd>hook:</kbd>として渡すことができます。
                </p>
                <pre class = 'prettyprint'><span class = 'shebang'>#! /usr/bin/env ruby</span>
require 'sisimai'
require 'json'
q = '{"notificationType": "Bounce", "bounce": {...'
o = JSON.load(q)
x = lambda do |argv|
  data = { 'acount-id' => nil }

  data['account-id'] = argv['bounces']['mail']['sendingAccountId']
  return data
end

j = Sisimai.dump(o, <strong>hook: x</strong>, input: 'json')    # JSON文字列を得る
v = Sisimai.make(o, <strong>hook: x</strong>, input: 'json')
puts v[0][<strong>'catch'</strong>]['account-id']  # 123456789012
                </pre>
            </div>
        </div>
        <div class = 'row'>
            <div class = 'col-sm-1 col-sm-offset-1'>
                <div class = 'index-label'>JSON</div>
            </div>
            <div class = 'col-sm-8 col-sm-offset-0'>
                <h3 class = 'in-desc'>dump()で出力したJSON</h3>
                <p class = 'description ja'>
                    Sisimaiの<kbd>dump()</kbd>メソッドにフックメソッドを渡して得たJSON文字列は
                    次のような内容になります。
                </p>
                <pre class = 'prettyprint'>
[
  {
    "timezoneoffset": "+0900",
    "reason": "userunknown",
    "replycode": "550",
    "messageid": "01010157e48f9b9b-891e9a0e-9c9d-4773-9bfe-608f2ef4756d-000000",
    "lhost": "a27-23.smtp-out.us-west-2.amazonses.com",
    "destination": "simulator.amazonses.com",
    "senderdomain": "neko.example.org",
    "diagnosticcode": "550 5.1.1 user unknown",
    "addresser": "kijitora@neko.example.org",
    <strong>"catch": {
      "account-id": 123456789012
    },</strong>
    "subject": "nyaan",
    "deliverystatus": "5.1.1",
    "token": "79f14902d1e4b8f9c40727609d7a752a1700564e",
    "feedbacktype": "",
    "softbounce": 0,
    "rhost": "",
    "smtpcommand": "",
    "smtpagent": "JSON::AmazonSES",
    "recipient": "bounce@simulator.amazonses.com",
    "alias": "",
    "diagnostictype": "SMTP",
    "listid": "",
    "action": "failed",
    "timestamp": 1476976000
  }
]
                </pre>

            </div>
        </div>

    </div>
</section> <!-- #callback -->

